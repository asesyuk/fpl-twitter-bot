name: FPL Twitter Bot

on:
  schedule:
    # Price changes - run at 2:30 AM GMT (when FPL prices update)
    - cron: '30 2 * * *'
    # Deadline reminders - run every hour
    - cron: '0 * * * *'
    # Daily stats - run at 8:00 AM GMT
    - cron: '0 8 * * *'

  workflow_dispatch:
    inputs:
      command:
        description: 'Command to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - price-changes
          - deadline
          - daily-stats
          - gw-results
      dry_run:
        description: 'Dry run (no actual tweets)'
        required: false
        default: false
        type: boolean

jobs:
  run-bot:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Restore price data
        uses: actions/cache@v4
        with:
          path: data/
          key: fpl-prices-${{ github.run_id }}
          restore-keys: |
            fpl-prices-

      # Determine which command to run based on trigger
      - name: Run scheduled price changes (2:30 AM)
        if: github.event_name == 'schedule' && github.event.schedule == '30 2 * * *'
        continue-on-error: true
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
        run: python main.py price-changes

      - name: Run scheduled deadline check (hourly)
        if: github.event_name == 'schedule' && github.event.schedule == '0 * * * *'
        continue-on-error: true
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
        run: python main.py deadline

      - name: Run scheduled daily stats (8 AM)
        if: github.event_name == 'schedule' && github.event.schedule == '0 8 * * *'
        continue-on-error: true
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
        run: python main.py daily-stats

      # Manual trigger
      - name: Run manual command
        if: github.event_name == 'workflow_dispatch'
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
        run: |
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            python main.py ${{ inputs.command }} --dry-run
          else
            python main.py ${{ inputs.command }}
          fi

      - name: Save price data
        uses: actions/cache/save@v4
        if: always()
        with:
          path: data/
          key: fpl-prices-${{ github.run_id }}
